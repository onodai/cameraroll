<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Image Feed</title>

  <style>
    /* ===== 基本リセット ===== */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* bodyスクロール禁止（iOS対策） */
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
    }

    /* ===== スクロール用コンテナ ===== */
    .feed {
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* iOS 慣性 */
    }

    /* ===== 各アイテム ===== */
    .item {
      margin-bottom: 24px;
    }

    /* ===== 画像 ===== */
    .item img {
      width: 100%;
      height: auto;
      max-height: 90vh;     /* 画面内に収める */
      object-fit: contain; /* 切らずに全体表示 */
      display: block;
      background: #000;    /* 余白が出た時用 */
    }

    /* ===== タイムスタンプ ===== */
    .timestamp {
      margin-top: 10px;    /* 画像から10px下 */
      padding-right: 8px;
      text-align: right;   /* 右下 */
      font-size: 12px;
      color: #666;
    }

    /* ===== スマホ最適化 ===== */
    @media (max-width: 600px) {
      .item {
        margin-bottom: 16px;
      }

      .item img {
        max-height: none;
      }
    }
  </style>
</head>
<body>

  <div class="feed" id="feed"></div>

  <script>
    const API_URL =
      "https://script.google.com/macros/s/AKfycbwnKCGF9XAjkUBjjy9UfSL7M1cKT7PJijeV98Sh2XMUBjPmxwwmKkIZExxL3L_MDdA8dw/exec
";

    const feed = document.getElementById("feed");

    let loopHeight = 0;
    let isAdjusting = false;

    fetch(API_URL)
      .then(res => res.json())
      .then(items => {
        // 新しい順に並び替え
        items.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        // 1セット目
        items.forEach(item => {
          feed.appendChild(createItem(item));
        });

        // 2セット目（コピー）
        items.forEach(item => {
          feed.appendChild(createItem(item));
        });

        // 画像読み込み後に高さ確定
        waitForImages().then(() => {
          loopHeight = feed.scrollHeight / 2;
        });

        feed.addEventListener("scroll", onScroll);
      });

    function onScroll() {
      if (isAdjusting || !loopHeight) return;

      // 後半に十分入ったら静かに巻き戻す
      if (feed.scrollTop > loopHeight * 1.1) {
        isAdjusting = true;
        feed.scrollTop -= loopHeight;

        requestAnimationFrame(() => {
          isAdjusting = false;
        });
      }
    }

    function createItem(item) {
      const wrapper = document.createElement("div");
      wrapper.className = "item";

      const img = document.createElement("img");
      img.src = item.image_url;
      img.loading = "lazy";

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent =
        new Date(item.timestamp).toLocaleString("ja-JP");

      wrapper.append(img, time);
      return wrapper;
    }

    function waitForImages() {
      const imgs = document.images;
      const promises = [];

      for (const img of imgs) {
        if (img.complete) continue;
        promises.push(
          new Promise(resolve => {
            img.onload = img.onerror = resolve;
          })
        );
      }

      return Promise.all(promises);
    }
  </script>

</body>
</html>
